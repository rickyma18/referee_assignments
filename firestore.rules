rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =====================================================================
    // HELPERS - Autenticación y UID
    // =====================================================================

    function uid() {
      return request.auth != null ? request.auth.uid : null;
    }

    function isAuthenticated() {
      return request.auth != null;
    }

    // =====================================================================
    // HELPERS - Role (prioridad: claims > userDoc)
    // =====================================================================

    // Lee role desde custom claims
    function roleFromClaims() {
      return request.auth.token.role;
    }

    // Lee role desde /users/{uid} (fallback transicional)
    function roleFromUsersDoc() {
      return uid() == null
        ? null
        : get(/databases/$(database)/documents/users/$(uid())).data.role;
    }

    // Role efectivo: claims si existe, si no userDoc
    function effectiveRole() {
      return roleFromClaims() != null ? roleFromClaims() : roleFromUsersDoc();
    }

    // Helpers de rol
    function hasRole(role) {
      return effectiveRole() == role;
    }

    function hasAnyRole(roles) {
      return effectiveRole() in roles;
    }

    function isSuperuser() {
      return hasRole("SUPERUSUARIO");
    }

    function isDelegate() {
      return hasRole("DELEGADO");
    }

    function isAssistant() {
      return hasRole("ASISTENTE");
    }

    function isReferee() {
      return hasRole("ARBITRO");
    }

    function canEdit() {
      return isSuperuser() || isDelegate();
    }

    // =====================================================================
    // HELPERS - DelegateId (prioridad: claims > userDoc)
    // =====================================================================

    // Lee delegateId desde custom claims
    function delegateIdFromClaims() {
      return request.auth.token.delegateId;
    }

    // Lee delegateId desde /users/{uid} (fallback transicional)
    function delegateIdFromUsersDoc() {
      return uid() == null
        ? null
        : get(/databases/$(database)/documents/users/$(uid())).data.delegateId;
    }

    // DelegateId efectivo: claims si existe, si no userDoc
    function effectiveDelegateId() {
      return delegateIdFromClaims() != null ? delegateIdFromClaims() : delegateIdFromUsersDoc();
    }

    // =====================================================================
    // HELPERS - Multi-tenant ownership
    // =====================================================================

    // Verifica si el recurso pertenece al delegado actual
    function resourceBelongsToDelegate() {
      return resource.data.delegateId == effectiveDelegateId();
    }

    // Verifica si el nuevo recurso tendrá el delegateId correcto
    function requestHasCorrectDelegateId() {
      return request.resource.data.delegateId == effectiveDelegateId();
    }

    // Lee el delegateId de una league específica
    function leagueDelegateId(leagueId) {
      return get(/databases/$(database)/documents/leagues/$(leagueId)).data.delegateId;
    }

    // Verifica si la league pertenece al delegado actual
    function leagueBelongsToDelegate(leagueId) {
      return leagueDelegateId(leagueId) == effectiveDelegateId();
    }

    // =====================================================================
    // COLECCIÓN: users
    // =====================================================================
    match /users/{userId} {
      // Lectura: cualquier usuario autenticado (para UI)
      allow read: if isAuthenticated();

      // Escritura: solo SUPERUSUARIO
      allow create, update, delete: if isSuperuser();
    }

    // =====================================================================
    // COLECCIÓN: leagues (multi-tenant)
    // =====================================================================
    match /leagues/{leagueId} {
      // SUPERUSUARIO: acceso total
      // DELEGADO: solo sus leagues
      // Otros: solo lectura de sus leagues
      allow read: if isAuthenticated() && (
        isSuperuser() ||
        resourceBelongsToDelegate()
      );

      allow create: if canEdit() && (
        isSuperuser() ||
        requestHasCorrectDelegateId()
      );

      allow update, delete: if canEdit() && (
        isSuperuser() ||
        resourceBelongsToDelegate()
      );

      // ===== Subcolección: groups =====
      match /groups/{groupId} {
        allow read: if isAuthenticated() && (
          isSuperuser() ||
          leagueBelongsToDelegate(leagueId)
        );

        allow create, update, delete: if canEdit() && (
          isSuperuser() ||
          leagueBelongsToDelegate(leagueId)
        );

        // ===== Subcolección: matchdays =====
        match /matchdays/{matchdayId} {
          allow read: if isAuthenticated() && (
            isSuperuser() ||
            leagueBelongsToDelegate(leagueId)
          );

          allow create, update, delete: if canEdit() && (
            isSuperuser() ||
            leagueBelongsToDelegate(leagueId)
          );

          // ===== Subcolección: matches =====
          match /matches/{matchId} {
            allow read: if isAuthenticated() && (
              isSuperuser() ||
              leagueBelongsToDelegate(leagueId)
            );

            allow create, update, delete: if canEdit() && (
              isSuperuser() ||
              leagueBelongsToDelegate(leagueId)
            );
          }
        }
      }
    }

    // =====================================================================
    // COLECCIÓN: teams (multi-tenant)
    // =====================================================================
    match /teams/{teamId} {
      allow read: if isAuthenticated() && (
        isSuperuser() ||
        resourceBelongsToDelegate()
      );

      allow create: if canEdit() && (
        isSuperuser() ||
        requestHasCorrectDelegateId()
      );

      allow update, delete: if canEdit() && (
        isSuperuser() ||
        resourceBelongsToDelegate()
      );
    }

    // =====================================================================
    // COLECCIÓN: referees (multi-tenant)
    // =====================================================================
    match /referees/{refereeId} {
      allow read: if isAuthenticated() && (
        isSuperuser() ||
        resourceBelongsToDelegate()
      );

      allow create: if canEdit() && (
        isSuperuser() ||
        requestHasCorrectDelegateId()
      );

      allow update, delete: if canEdit() && (
        isSuperuser() ||
        resourceBelongsToDelegate()
      );
    }

    // =====================================================================
    // COLECCIÓN: venues (catálogo compartido)
    // Lectura: todos los autenticados
    // Escritura: solo SUPERUSUARIO (catálogo global)
    // =====================================================================
    match /venues/{venueId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isSuperuser();
    }

    // =====================================================================
    // COLECCIÓN: zones (catálogo compartido)
    // Lectura: todos los autenticados
    // Escritura: solo SUPERUSUARIO (catálogo global)
    // =====================================================================
    match /zones/{zoneId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isSuperuser();
    }

    // =====================================================================
    // COLECCIÓN: designaciones (multi-tenant)
    // =====================================================================
    match /designaciones/{docId} {
      // Lectura: cualquier rol válido, filtrado por delegateId
      allow read: if isAuthenticated() && hasAnyRole(["SUPERUSUARIO", "DELEGADO", "ASISTENTE", "ARBITRO"]) && (
        isSuperuser() ||
        resourceBelongsToDelegate()
      );

      // Escritura: solo SUPERUSUARIO o DELEGADO
      allow create: if canEdit() && (
        isSuperuser() ||
        requestHasCorrectDelegateId()
      );

      allow update, delete: if canEdit() && (
        isSuperuser() ||
        resourceBelongsToDelegate()
      );
    }

    // =====================================================================
    // DEFAULT DENY - Cualquier otra colección
    // =====================================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
